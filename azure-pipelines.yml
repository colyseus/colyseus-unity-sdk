# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  batch: true
  branches:
    include:
    - master
    - releases/*

stages:
- stage: build
  jobs:
  - job: build
    pool:
      vmImage: 'windows-latest'
    steps:
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: plugins'
      inputs:
        PathtoPublish: Assets/Plugins
        ArtifactName: plugins
- stage: release
  dependsOn: build
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/release')
  jobs:
  - job: github_release
    pool:
      vmImage: 'windows-latest'
    steps:
    - task: ArchiveFiles@2
      displayName: 'Archive $(System.DefaultWorkingDirectory)/_colyseus-unity3d-CI/plugins'
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/_colyseus-unity3d-CI/plugins'
        archiveFile: '$(Build.ArtifactStagingDirectory)/plugins-$(Build.SourceBranchName).zip'
    - task: GitHubRelease@1
      displayName: 'GitHub release (create)'
      inputs:
        gitHubConnection: 'colyseus'
        tagSource: userSpecifiedTag
        tag: '$(Build.SourceBranchName)'
        title: '$(Build.SourceBranchName)'
        assets: '$(Build.ArtifactStagingDirectory)/*.zip'
        isDraft: true